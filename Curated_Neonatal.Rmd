---
title: "Harmonize Neonatal-Related Attributes in cMD Metadata"
author:
  - Britney Pheng, Sehyun Oh <br>
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
    html:
        fontsize: 14pxs
        toc: true
        top-depth: 3
output: github_document
---

# Setup
## Load packages
```{r install packages, eval=FALSE}
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install('curatedMetagenomicData')
```

```{r}
suppressPackageStartupMessages({
  library(curatedMetagenomicData)
  library(tidyverse)
})
```

## Load data
**Comment:**
This new object, `data`, seems unnecessary.
```{r sampleMetadata, echo=FALSE}
data <- sampleMetadata
```

_**Comment:**_
I removed the `lactating` column.

```{r neonatal columns}
## A list of neonatal data column names
neonatal_cols <- c("age_category",
                   "infant_age",
                   "born_method", 
                   "gestational_age",
                   "premature",
                   "birth_weight",
                   "c_section_type",
                   "feeding_practice",
                   "formula_first_day",
                   "breastfeeding_duration")
```

```{r curated neonatal dataframe, warning=FALSE}
tb <- sampleMetadata %>%
    mutate(curation_id = paste(study_name, sample_id, sep = ":")) %>%
    dplyr::select(curation_id, neonatal_cols)
```

# neonatal_delivery_procedure
The two original columns `born_method` and `c_section_type` are harmonized to
the curated column, `neonatal_delivery_procedure`.

## EDA
```{r}
## 782 sapmles have information from both `born_method` and `c_section_type`
na_summary <- rowSums(!is.na(tb[c("born_method", "c_section_type")]))
table(na_summary)

## All the used terms
unique(tb$born_method)
unique(tb$c_section_type)
```

```{r}
both_ind <- which(na_summary == 2)
unique(tb$born_method[both_ind])
unique(tb$c_section_type)

## No sample has only `c_section_type` info
sum(is.na(tb$born_method) & !is.na(tb$c_section_type)) 
```

## Consolidate redundant info
```{r curated delivery procedure}
tb$source <- NA
tb$value <- NA

for (i in seq_len(nrow(tb))) {
    if (is.na(tb$born_method[i])) {
        tb$source[i] <- NA
        tb$value[i] <- NA
    } else if (!is.na(tb$born_method[i]) & is.na(tb$c_section_type[i])) {
        tb$source[i] <- "born_method"
        tb$value[i] <- tb$born_method[i]
    } else {
        tb$source[i] <- "c_section_type"
        tb$value[i] <- tb$c_section_type[i]
    }
}
```

## Curate ontology terms
### Create curation map
The 'allowedvalues' and their 'ontology ids' are available in the data 
dictionary Google Sheet, `cMD_data_dictionary`, or in the GitHub repo.

You can look up the format of the curation maps in the manuscript's 
supplementary method section or other curation maps.

```{r}
delivery_map <- data.frame(
    original_value = c("Elective_CS", 
                       "Emergency_CS",
                       "c_section",
                       "vaginal"),
    curated_ontology_term = c("Elective Cesarean Delivery", 
                              "Emergency Cesarean Delivery",
                              "Cesarean Section",
                              "Vaginal Delivery"),
    curated_ontology_term_id = c("NCIT:C114141", 
                                 "NCIT:C92772", 
                                 "NCIT:C46088", 
                                 "NCIT:C81303"),
    curated_ontology_term_db = c("NCIT", "NCIT", "NCIT", "NCIT")
)
```
  
### Update the metadata with the curated terms 
```{r}
curated_dat <- tb %>%
    transmute(curation_id = curation_id,
              original_source = source,
              original_value = value,
              curated_ontology_term = plyr::mapvalues(
                  x = value, 
                  from = delivery_map$original_value,
                  to = delivery_map$curated_ontology_term,
                  warn_missing = FALSE
              )) %>%
    mutate(curated_ontology_term_id = plyr::mapvalues(
        x = curated_ontology_term,
        from = delivery_map$curated_ontology_term,
        to = delivery_map$curated_ontology_term_id,
        warn_missing = FALSE
    )) %>%
    mutate(curated_ontology_term_db = plyr::mapvalues(
        x = curated_ontology_term,
        from = delivery_map$curated_ontology_term,
        to = delivery_map$curated_ontology_term_db,
        warn_missing = FALSE
    ))
```

Check the harmonized/curated metadata
```{r}
non_na_ind <- which(!is.na(curated_dat$original_source))
head(curated_dat[c(1:3, non_na_ind),])
```

## Save the results
```{r}
readr::write_csv(delivery_map, "maps/cMD_delivery_procedure_map.csv")
readr::write_csv(curated_dat, "data/curated_delivery_procedure.csv")
```


#### Clean up *premature* column into curated *neonatal_preterm_birth* column
Use **gestational_age** data element to clean up premature status. 

Pre-maturity (preterm birth) is defined as any birth less than 37 weeks and 0 days gestational age.
```{r curated preterm birth}
nn.ds$neonatal_preterm_birth <- NA

for (i in 1:nrow(nn.ds)) {
  if (is.na(nn.ds$gestational_age[i])) {
    nn.ds$neonatal_preterm_birth[i] <- nn.ds$premature[i]
  } else {
    if (nn.ds$gestational_age[i] < 37) {
      nn.ds$neonatal_preterm_birth[i] <- 'yes'
    } else if (nn.ds$gestational_age[i] >= 37) {
      nn.ds$neonatal_preterm_birth[i] <- 'no'
    } else {
      nn.ds$neonatal_preterm_birth[i] <- nn.ds$premature[x]
    }
  }
}
```
#### Clean up *feeding_practice* column into curated *neonatal_feeding_method* column
Replace "any_breastfeeding" **feeding_practice** data element answer with "exclusively_breastfeeding; mixed_feeding" answer.

Clean up "exclusively_breastfeeding" answer in the **feeding_practice** column to include any infant who was breastfed *and* did not receive formula between the time of birth and data collection. If **infant_age** data element is less than the day marked for **formula_first_day** element and there is a valid (non-NA) **breastfeeding_duration** answer, change feeding method answer to "exclusively_breastfeeding". This is with the notion that **infant_age** column provides the age of the infant at the time that samples were collected.
```{r curated feeding method}
nn.ds$neonatal_feeding_method <- NA

for (i in 1:nrow(nn.ds)) {
  if (is.na(nn.ds$feeding_practice[i])) {
    nn.ds$neonatal_feeding_method[i] <- nn.ds$feeding_practice[i]
  } else if (nn.ds$feeding_practice[i] == 'any_breastfeeding') {
    nn.ds$neonatal_feeding_method[i] <- 'exclusively_breastfeeding; mixed_feeding'
  } else if (is.na(nn.ds$formula_first_day[i]) == TRUE) {
    nn.ds$neonatal_feeding_method[i] <- nn.ds$feeding_practice[i]
  } else if (!(nn.ds$formula_first_day[i] <= nn.ds$infant_age[i]) 
             & !(is.na(nn.ds$breastfeeding_duration[i]))) {
    nn.ds$neonatal_feeding_method[i] <- 'exclusively_breastfeeding'
  } else {
    nn.ds$neonatal_feeding_method[i] <- nn.ds$feeding_practice[i]
  }
}
```
#### Rename unchanged neonatal data columns
```{r rename data columns, results='hide'}
nn.ds %>% 
  rename(
    neonatal_birth_weight = birth_weight,
    neonatal_gestational_age = gestational_age)
```
#### Generate a .csv file with the curated neonatal data columns
```{r create csv file}
write.csv(nn.ds, file = 'curated_neonatal_cols.csv')
```